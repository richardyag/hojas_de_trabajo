<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ═══════════════════════════════════════════════════════════════════════
         GRUPOS
    ═══════════════════════════════════════════════════════════════════════ -->

    <record id="group_field_service_user" model="res.groups">
        <field name="name">Usuario de Servicios</field>
    </record>

    <record id="group_field_service_manager" model="res.groups">
        <field name="name">Gerente de Servicios</field>
        <field name="implied_ids" eval="[(4, ref('group_field_service_user'))]"/>
    </record>

    <!-- ═══════════════════════════════════════════════════════════════════════
         REGLAS DE ACCESO A REGISTROS
    ═══════════════════════════════════════════════════════════════════════ -->

    <!-- Gerente: ve todo -->
    <record id="rule_fso_manager_all" model="ir.rule">
        <field name="name">FSO: Gerente ve todo</field>
        <field name="model_id" ref="model_field_service_order"/>
        <field name="groups" eval="[(4, ref('group_field_service_manager'))]"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Usuario interno: ve sus propias + las asignadas -->
    <record id="rule_fso_user_own" model="ir.rule">
        <field name="name">FSO: Usuario ve sus órdenes</field>
        <field name="model_id" ref="model_field_service_order"/>
        <field name="groups" eval="[(4, ref('base.group_user'))]"/>
        <field name="domain_force">[
            '|',
            ('user_id', '=', user.id),
            ('technician_id', '=', user.id)
        ]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Portal (técnico): solo ve sus órdenes asignadas -->
    <record id="rule_fso_portal_technician" model="ir.rule">
        <field name="name">FSO: Técnico portal ve sus órdenes</field>
        <field name="model_id" ref="model_field_service_order"/>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="domain_force">[('technician_id.partner_id', '=', user.partner_id.id)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Líneas: portal puede leer líneas de sus órdenes -->
    <record id="rule_fsl_portal" model="ir.rule">
        <field name="name">FSL: Portal lee líneas de sus órdenes</field>
        <field name="model_id" ref="model_field_service_line"/>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="domain_force">[
            ('order_id.technician_id.partner_id', '=', user.partner_id.id)
        ]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Pagos: portal puede leer pagos de sus órdenes -->
    <record id="rule_fsp_portal" model="ir.rule">
        <field name="name">FSP: Portal lee pagos de sus órdenes</field>
        <field name="model_id" ref="model_field_service_payment"/>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="domain_force">[
            ('order_id.technician_id.partner_id', '=', user.partner_id.id)
        ]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

</odoo>
